<ContentDialog
    x:Class="MyShopClient.Views.Orders.ProductSelectionDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MyShopClient.Views.Orders"
    xmlns:vm="using:MyShopClient.ViewModels"
    xmlns:api="using:MyShopClient.Services.Api"
    xmlns:models="using:MyShopClient.Models"
    xmlns:helpers="using:MyShopClient.Helpers"
    Title="Select Product"
    PrimaryButtonText="Add to Order"
    SecondaryButtonText="Cancel"
    DefaultButton="Primary"
    Style="{StaticResource DefaultContentDialogStyle}"
    RequestedTheme="{x:Bind RequestedTheme, Mode=OneWay}">

    <ContentDialog.Resources>
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        
        <DataTemplate x:Key="ProductItemTemplate" x:DataType="models:ApiProduct">
            <Grid Padding="12" Background="{ThemeResource SystemChromeLowColor}" CornerRadius="4" Margin="0,0,0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <Border Width="48" Height="48" CornerRadius="4" Margin="0,0,12,0" Background="#f0f0f0">
                   <!-- Placeholder for image, or first image if available -->
                   <Image Source="/Assets/placeholder.png" Stretch="UniformToFill"/>
                </Border>
                
                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="{x:Bind Name}" FontWeight="SemiBold"/>
                    <TextBlock Text="{x:Bind Sku}" FontSize="12" Foreground="{ThemeResource TextSecondaryBrush}"/>
                </StackPanel>
                
                <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Right">
                    <TextBlock Text="{x:Bind FormattedPrice}" FontWeight="Bold" HorizontalAlignment="Right"/>
                    <TextBlock Text="{x:Bind Stock, Converter={StaticResource StockToStringConverter}}" FontSize="12" Foreground="{ThemeResource TextSecondaryBrush}" HorizontalAlignment="Right"/>
                </StackPanel>
            </Grid>
        </DataTemplate>
        
        <!-- Quick converter for UI binding -->
        <helpers:StockToStringConverter x:Key="StockToStringConverter"/>
    </ContentDialog.Resources>

    <Grid Width="600" Height="600">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Search Bar -->
        <Grid Grid.Row="0" ColumnSpacing="8" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBox 
                PlaceholderText="Search product by name, sku..." 
                Text="{x:Bind ViewModel.SearchKeyword, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                KeyDown="SearchBox_KeyDown"/>
            <Button Grid.Column="1" Command="{x:Bind ViewModel.SearchCommand}">
                <FontIcon Glyph="&#xE721;"/>
            </Button>
        </Grid>

        <!-- Loading -->
        <ProgressBar 
            Grid.Row="1" 
            VerticalAlignment="Top" 
            IsIndeterminate="True" 
            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

        <!-- Product List -->
        <ListView
            Grid.Row="1"
            ItemsSource="{x:Bind ViewModel.Products, Mode=OneWay}"
            SelectedItem="{x:Bind ViewModel.SelectedProduct, Mode=TwoWay}"
            SelectionMode="Single"
            ItemTemplate="{StaticResource ProductItemTemplate}">
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                </Style>
            </ListView.ItemContainerStyle>
        </ListView>

        <!-- Pagination -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="4" Margin="0,16,0,0">
            <Button Command="{x:Bind ViewModel.PreviousPageCommand}" IsEnabled="{x:Bind ViewModel.CanGoPrev, Mode=OneWay}" Style="{StaticResource DateTimePickerFlyoutButtonStyle}">
                <FontIcon Glyph="&#xE76B;" FontSize="12"/>
            </Button>
            
            <ItemsControl ItemsSource="{x:Bind ViewModel.Pages, Mode=OneWay}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal" Spacing="4"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:PageInfo">
                        <Button 
                            Content="{x:Bind Text}" 
                            Command="{x:Bind Command}"
                            IsEnabled="{x:Bind IsEnabled}"
                            Background="{x:Bind Background}"
                            Foreground="{x:Bind Foreground}"
                            BorderThickness="{x:Bind BorderThickness}"
                            MinWidth="32"
                            Padding="0"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            
            <Button Command="{x:Bind ViewModel.NextPageCommand}" IsEnabled="{x:Bind ViewModel.CanGoNext, Mode=OneWay}" Style="{StaticResource DateTimePickerFlyoutButtonStyle}">
                <FontIcon Glyph="&#xE76C;" FontSize="12"/>
            </Button>
        </StackPanel>
    </Grid>
</ContentDialog>
