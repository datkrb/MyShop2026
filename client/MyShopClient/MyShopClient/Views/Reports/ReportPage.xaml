<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MyShopClient.Views.Reports.ReportPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:MyShopClient.Views.Reports"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:lvc="using:LiveChartsCore.SkiaSharpView.WinUI"
    xmlns:models="using:MyShopClient.Models"
    xmlns:helpers="using:MyShopClient.Helpers"
    xmlns:shared="using:MyShopClient.Views.Shared"
    mc:Ignorable="d"
    Background="{ThemeResource AppBackgroundBrush}">

    <Page.Resources>
        <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <helpers:InverseBoolToVisibilityConverter x:Key="BoolToVisibilityInverseConverter"/>
        
        <!-- Table Header Style -->
        <Style x:Key="TableHeaderTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{ThemeResource TextSecondaryBrush}"/>
            <Setter Property="CharacterSpacing" Value="50"/>
        </Style>
    </Page.Resources>

    <Grid x:Name="RootGrid" Padding="24,0,2,12">
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <!-- Large: 2 columns for charts, inline filters -->
                <VisualState x:Name="LargeState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="1200"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RevenueChartCol.Width" Value="2*"/>
                        <Setter Target="RevenueSummaryCol.Width" Value="*"/>
                        <Setter Target="ProductChartCol.Width" Value="2*"/>
                        <Setter Target="ProductSummaryCol.Width" Value="*"/>
                        <Setter Target="ProfitChartCol.Width" Value="2*"/>
                        <Setter Target="ProfitSummaryCol.Width" Value="*"/>
                        <Setter Target="InlineFiltersPanel.Visibility" Value="Visible"/>
                        <Setter Target="FilterButton.Visibility" Value="Collapsed"/>
                    </VisualState.Setters>
                </VisualState>
                
                <!-- Medium: 2 columns for charts, flyout filters -->
                <VisualState x:Name="MediumState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="900"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RevenueChartCol.Width" Value="2*"/>
                        <Setter Target="RevenueSummaryCol.Width" Value="*"/>
                        <Setter Target="ProductChartCol.Width" Value="2*"/>
                        <Setter Target="ProductSummaryCol.Width" Value="*"/>
                        <Setter Target="ProfitChartCol.Width" Value="2*"/>
                        <Setter Target="ProfitSummaryCol.Width" Value="*"/>
                        <Setter Target="InlineFiltersPanel.Visibility" Value="Collapsed"/>
                        <Setter Target="FilterButton.Visibility" Value="Visible"/>
                    </VisualState.Setters>
                </VisualState>
                
                <!-- Small: stacked charts, flyout filters -->
                <VisualState x:Name="SmallState">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="RevenueChartCol.Width" Value="*"/>
                        <Setter Target="RevenueSummaryCol.Width" Value="0"/>
                        <Setter Target="RevenueSummaryCard.Visibility" Value="Collapsed"/>
                        <Setter Target="ProductChartCol.Width" Value="*"/>
                        <Setter Target="ProductSummaryCol.Width" Value="0"/>
                        <Setter Target="ProductSummaryCard.Visibility" Value="Collapsed"/>
                        <Setter Target="ProfitChartCol.Width" Value="*"/>
                        <Setter Target="ProfitSummaryCol.Width" Value="0"/>
                        <Setter Target="ProfitSummaryCard.Visibility" Value="Collapsed"/>
                        <Setter Target="InlineFiltersPanel.Visibility" Value="Collapsed"/>
                        <Setter Target="FilterButton.Visibility" Value="Visible"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="*"/>    <!-- Content -->
        </Grid.RowDefinitions>

        <!-- Page Header -->
        <shared:PageHeader 
            Margin="-24,0,-24,2"
            Title="Reports &amp; Analytics" 
            Description="View sales reports, revenue trends and performance metrics."/>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="0,0,22,0">
            <StackPanel Spacing="24">
                
                <!-- Page Header -->
                <StackPanel Spacing="16">
                    <!-- Title -->
                    <StackPanel Spacing="4">
                        <TextBlock 
                            Text="Reports &amp; Analytics" 
                            FontSize="28" 
                            FontWeight="Bold" 
                            Foreground="{ThemeResource TextPrimaryBrush}"/>
                        <TextBlock 
                            Text="View sales reports, revenue trends and performance metrics." 
                            FontSize="14" 
                            Foreground="{ThemeResource TextSecondaryBrush}"/>
                    </StackPanel>

                    <!-- Filters Row -->
                    <Border Style="{StaticResource CardBorderStyle}" Padding="16">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Filter Controls -->
                            <StackPanel x:Name="InlineFiltersPanel" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Start Date" FontSize="11" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <CalendarDatePicker Date="{x:Bind ViewModel.StartDate, Mode=TwoWay}" PlaceholderText="Start Date"/>
                                </StackPanel>
                                <StackPanel Spacing="4">
                                    <TextBlock Text="End Date" FontSize="11" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <CalendarDatePicker Date="{x:Bind ViewModel.EndDate, Mode=TwoWay}" PlaceholderText="End Date"/>
                                </StackPanel>
                                <StackPanel Spacing="4">
                                    <TextBlock Text="View By" FontSize="11" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <ComboBox SelectedItem="{x:Bind ViewModel.SelectedReportType, Mode=TwoWay}" ItemsSource="{x:Bind ViewModel.ReportTypes}" MinWidth="100"/>
                                </StackPanel>
                                <StackPanel Spacing="4">
                                    <TextBlock Text="Category" FontSize="11" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <ComboBox ItemsSource="{x:Bind ViewModel.Categories, Mode=OneWay}" SelectedItem="{x:Bind ViewModel.SelectedCategory, Mode=TwoWay}" MinWidth="130"/>
                                </StackPanel>

                            </StackPanel>
                            
                            <!-- Action Buttons -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                                <Button Content="Load Data" Command="{x:Bind ViewModel.LoadDataCommand}" Style="{ThemeResource AccentButtonStyle}"/>
                                <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}" Width="24" Height="24"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </StackPanel>
                
                <!-- Revenue Section -->
                <Grid ColumnSpacing="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition x:Name="RevenueChartCol" Width="2*"/>
                        <ColumnDefinition x:Name="RevenueSummaryCol" Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Revenue Chart -->
                    <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Height="350">
                        <Grid Padding="20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="Revenue &amp; Trends" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}" Margin="0,0,0,12"/>
                            <lvc:CartesianChart Grid.Row="1" Series="{x:Bind ViewModel.RevenueSeries, Mode=OneWay}" XAxes="{x:Bind ViewModel.RevenueXAxes, Mode=OneWay}"/>
                        </Grid>
                    </Border>
                    
                    <!-- Revenue Summary Table -->
                    <Border x:Name="RevenueSummaryCard" Grid.Column="1" Style="{StaticResource CardBorderStyle}" Height="350">
                        <Grid Padding="20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="Revenue Summary" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}" Margin="0,0,0,12"/>
                            <StackPanel Grid.Row="1" Spacing="16">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Total Revenue" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.TotalRevenue, Mode=OneWay}" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Highest Day" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.HighestRevenueDay, Mode=OneWay}" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Average/Day" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.AverageRevenue, Mode=OneWay}" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Data Points" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.RevenueDataPoints, Mode=OneWay}" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Top 5 Products Section -->
                <Grid ColumnSpacing="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition x:Name="ProductChartCol" Width="2*"/>
                        <ColumnDefinition x:Name="ProductSummaryCol" Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Products Chart -->
                    <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Height="350">
                        <Grid Padding="20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="Top 5 Products (by Quantity)" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}" Margin="0,0,0,12"/>
                            <lvc:CartesianChart Grid.Row="1" Series="{x:Bind ViewModel.ProductSalesSeries, Mode=OneWay}" XAxes="{x:Bind ViewModel.ProductSalesXAxes, Mode=OneWay}" TooltipPosition="Top"/>
                        </Grid>
                    </Border>
                    
                    <!-- Products Summary Table -->
                    <Border x:Name="ProductSummaryCard" Grid.Column="1" Style="{StaticResource CardBorderStyle}" Height="350">
                        <Grid Padding="20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="Top Products" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}" Margin="0,0,0,12"/>
                            <ListView Grid.Row="1" ItemsSource="{x:Bind ViewModel.TopProductsList, Mode=OneWay}" SelectionMode="None">
                                <ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="0,8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="{Binding Name}" TextTrimming="CharacterEllipsis" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Quantity}" FontWeight="SemiBold" Margin="8,0,0,0" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Profit Section -->
                <Grid ColumnSpacing="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition x:Name="ProfitChartCol" Width="2*"/>
                        <ColumnDefinition x:Name="ProfitSummaryCol" Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Profit Chart -->
                    <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Height="350">
                        <Grid Padding="20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="Profit vs Cost" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}" Margin="0,0,0,12"/>
                            <lvc:PieChart Grid.Row="1" Series="{x:Bind ViewModel.ProfitSeries, Mode=OneWay}" LegendPosition="Right"/>
                        </Grid>
                    </Border>
                    
                    <!-- Profit Summary Table -->
                    <Border x:Name="ProfitSummaryCard" Grid.Column="1" Style="{StaticResource CardBorderStyle}" Height="350">
                        <Grid Padding="20">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="Profit Summary" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}" Margin="0,0,0,12"/>
                            <StackPanel Grid.Row="1" Spacing="16">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Total Revenue" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.ProfitRevenue, Mode=OneWay}" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Total Cost" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.ProfitCost, Mode=OneWay}" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Net Profit" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.NetProfit, Mode=OneWay}" FontWeight="SemiBold" Foreground="{ThemeResource SuccessBrush}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Profit Margin" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="{x:Bind ViewModel.ProfitMargin, Mode=OneWay}" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Profit Time Series Section (NEW) -->
                <Border Style="{StaticResource CardBorderStyle}" Height="350">
                    <Grid Padding="20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="Profit Trend" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}" Margin="0,0,0,12"/>
                        <lvc:CartesianChart Grid.Row="1" Series="{x:Bind ViewModel.ProfitTimeSeriesSeries, Mode=OneWay}" XAxes="{x:Bind ViewModel.ProfitTimeSeriesXAxes, Mode=OneWay}" TooltipPosition="Top"/>
                    </Grid>
                </Border>

                <!-- Sales Analysis Section (Merged Product & Category) -->
                <Border Style="{StaticResource CardBorderStyle}" Height="400">
                    <Grid Padding="20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Header with toggle -->
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="16" Margin="0,0,0,12">
                            <TextBlock Text="Sales Analysis" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                            
                            <!-- Analysis Mode Toggle -->
                            <StackPanel Spacing="4">
                                <TextBlock Text="Analyze By" FontSize="11" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                <ComboBox ItemsSource="{x:Bind ViewModel.AnalysisModes}" 
                                          SelectedItem="{x:Bind ViewModel.SelectedAnalysisMode, Mode=TwoWay}" 
                                          MinWidth="120"/>
                            </StackPanel>
                            
                            <!-- Product Selector (visible when Product mode) -->
                            <StackPanel Spacing="4" Visibility="{x:Bind ViewModel.IsProductMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="Select Product" FontSize="11" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                <ComboBox ItemsSource="{x:Bind ViewModel.AvailableProducts, Mode=OneWay}" 
                                          SelectedItem="{x:Bind ViewModel.SelectedProduct, Mode=TwoWay}" 
                                          DisplayMemberPath="Name"
                                          MinWidth="200"/>
                            </StackPanel>

                            <!-- Metric Selector (visible when Product mode) -->
                            <StackPanel Spacing="4" Visibility="{x:Bind ViewModel.IsProductMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="Metric" FontSize="11" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                <ComboBox SelectedItem="{x:Bind ViewModel.SelectedMetricType, Mode=TwoWay}" ItemsSource="{x:Bind ViewModel.MetricTypes}" MinWidth="100"/>
                            </StackPanel>
                            
                            <!-- Category Selector (visible when Category mode) -->
                            <StackPanel Spacing="4" Visibility="{x:Bind ViewModel.IsCategoryMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="Filter Category" FontSize="11" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                <ComboBox ItemsSource="{x:Bind ViewModel.Categories, Mode=OneWay}" 
                                          SelectedItem="{x:Bind ViewModel.SelectedCategoryForAnalysis, Mode=TwoWay}"
                                          MinWidth="150"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <!-- Product Chart (visible when Product mode) -->
                        <lvc:CartesianChart Grid.Row="1" 
                                           Series="{x:Bind ViewModel.SingleProductSeries, Mode=OneWay}" 
                                           XAxes="{x:Bind ViewModel.SingleProductXAxes, Mode=OneWay}" 
                                           TooltipPosition="Top"
                                           Visibility="{x:Bind ViewModel.IsProductMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        
                        <!-- Category Chart (visible when Category mode) -->
                        <lvc:CartesianChart Grid.Row="1" 
                                           Series="{x:Bind ViewModel.CategorySalesSeries, Mode=OneWay}" 
                                           XAxes="{x:Bind ViewModel.CategorySalesXAxes, Mode=OneWay}" 
                                           TooltipPosition="Top" 
                                           LegendPosition="Right"
                                           Visibility="{x:Bind ViewModel.IsCategoryMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </Grid>
                </Border>
                
                <!-- KPI & Commission Section -->
                <Border Style="{StaticResource CardBorderStyle}">
                    <Grid Padding="20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Header with filters -->
                        <Grid Grid.Row="0" Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="KPI &amp; Commission" FontSize="16" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12">
                                <ComboBox Header="Year" ItemsSource="{x:Bind ViewModel.KpiYears, Mode=OneWay}" SelectedItem="{x:Bind ViewModel.SelectedKpiYear, Mode=TwoWay}" MinWidth="100"/>
                                <ComboBox Header="Month" ItemsSource="{x:Bind ViewModel.KpiMonths, Mode=OneWay}" SelectedItem="{x:Bind ViewModel.SelectedKpiMonth, Mode=TwoWay}" MinWidth="100" PlaceholderText="All"/>
                                <Button Content="Load KPI" Command="{x:Bind ViewModel.LoadKpiCommand}" VerticalAlignment="Bottom" Style="{ThemeResource AccentButtonStyle}"/>
                            </StackPanel>
                        </Grid>
                        
                        <!-- Admin View: DataGrid with all employees' KPI -->
                        <Grid Grid.Row="1" Visibility="{x:Bind ViewModel.IsAdmin, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                            <ListView ItemsSource="{x:Bind ViewModel.KpiItems, Mode=OneWay}" SelectionMode="None" MaxHeight="300">
                                <ListView.HeaderTemplate>
                                    <DataTemplate>
                                        <Grid Padding="12" Background="{ThemeResource SystemChromeLowColor}">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="2*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="1.2*"/>
                                                <ColumnDefinition Width="0.8*"/>
                                                <ColumnDefinition Width="1.5*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="USERNAME" Style="{StaticResource TableHeaderTextStyle}"/>
                                            <TextBlock Grid.Column="1" Text="ROLE" Style="{StaticResource TableHeaderTextStyle}"/>
                                            <TextBlock Grid.Column="2" Text="ORDERS" Style="{StaticResource TableHeaderTextStyle}" TextAlignment="Right"/>
                                            <TextBlock Grid.Column="3" Text="REVENUE" Style="{StaticResource TableHeaderTextStyle}" TextAlignment="Right"/>
                                            <TextBlock Grid.Column="4" Text="RATE" Style="{StaticResource TableHeaderTextStyle}" TextAlignment="Right"/>
                                            <TextBlock Grid.Column="5" Text="COMMISSION" Style="{StaticResource TableHeaderTextStyle}" TextAlignment="Right"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListView.HeaderTemplate>
                                <ListView.ItemTemplate>
                                    <DataTemplate x:DataType="models:KpiSalesItem">
                                        <Grid Padding="12" BorderBrush="{ThemeResource BorderBrush}" BorderThickness="0,0,0,1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="2*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="1.2*"/>
                                                <ColumnDefinition Width="0.8*"/>
                                                <ColumnDefinition Width="1.5*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{x:Bind User.Username}" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                            <TextBlock Grid.Column="1" Text="{x:Bind User.Role}" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                            <TextBlock Grid.Column="2" Text="{x:Bind Orders}" TextAlignment="Right" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                            <TextBlock Grid.Column="3" Text="{x:Bind RevenueDisplay}" TextAlignment="Right" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                            <TextBlock Grid.Column="4" Text="{x:Bind CommissionRateDisplay}" TextAlignment="Right" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                            <TextBlock Grid.Column="5" Text="{x:Bind CommissionDisplay}" TextAlignment="Right" Foreground="{ThemeResource SuccessBrush}" FontWeight="SemiBold"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListView.ItemTemplate>
                            </ListView>
                        </Grid>
                        
                        <!-- Sale User View: Own KPI Card -->
                        <Grid Grid.Row="2" Visibility="{x:Bind ViewModel.IsAdmin, Mode=OneWay, Converter={StaticResource BoolToVisibilityInverseConverter}}" Margin="0,8,0,0">
                            <StackPanel Spacing="16" x:Name="MyKpiPanel">
                                <TextBlock Text="My Performance" FontWeight="SemiBold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                <Grid ColumnSpacing="24">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" Spacing="4">
                                        <TextBlock Text="Orders" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{x:Bind ViewModel.MyKpiOrders, Mode=OneWay}" FontSize="24" FontWeight="Bold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Spacing="4">
                                        <TextBlock Text="Revenue" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{x:Bind ViewModel.MyKpiRevenue, Mode=OneWay}" FontSize="24" FontWeight="Bold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2" Spacing="4">
                                        <TextBlock Text="Rate" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{x:Bind ViewModel.MyKpiRate, Mode=OneWay}" FontSize="24" FontWeight="Bold" Foreground="{ThemeResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="3" Spacing="4">
                                        <TextBlock Text="Commission" Foreground="{ThemeResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{x:Bind ViewModel.MyKpiCommission, Mode=OneWay}" FontSize="24" FontWeight="Bold" Foreground="{ThemeResource SuccessBrush}"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>
                
            </StackPanel>
        </ScrollViewer>
        
        <!-- Loading Overlay -->
        <Grid 
            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
            Background="{ThemeResource LayerOnMicaBaseAltFillColorDefaultBrush}">
            <StackPanel 
                HorizontalAlignment="Center" 
                VerticalAlignment="Center"
                Spacing="16">
                <ProgressRing IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}" Width="48" Height="48"/>
                <TextBlock 
                    Text="Loading reports..." 
                    Foreground="{ThemeResource TextSecondaryBrush}"
                    HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
